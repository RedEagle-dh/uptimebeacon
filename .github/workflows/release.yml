name: Release

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      force_frontend:
        description: 'Force frontend release'
        type: boolean
        default: false
      force_backend:
        description: 'Force backend release'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  # Detect which apps have changes
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      shared: ${{ steps.changes.outputs.shared }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
            backend:
              - 'apps/backend/**'
            shared:
              - 'packages/**'

  # Release frontend
  release-frontend:
    name: Release Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend == 'true' ||
      needs.detect-changes.outputs.shared == 'true' ||
      github.event.inputs.force_frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.3

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Semantic Release (Frontend)
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        working-directory: apps/frontend
        run: bunx semantic-release

  # Release backend
  release-backend:
    name: Release Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.shared == 'true' ||
      github.event.inputs.force_backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.3

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Semantic Release (Backend)
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        working-directory: apps/backend
        run: bunx semantic-release
